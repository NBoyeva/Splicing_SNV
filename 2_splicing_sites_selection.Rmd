---
title: "Splising Sites Selection"
author: "Nadzeya Boyeva"
date: "2024-11-05"
output: pdf_document
---

```{r}
library(dplyr)
library(edgeR)
source("/home/nadzeya/Documents/GitHub/Splicing_SNV/2_splicing_sites_selection_functions.R")
```


# Sites from EEJ gene related matrices

```{r}
fd <- '/home/nadzeya/praktika/'

readTxt <- function(path) {
  read.table(file=path, 
             sep="\t",
             header=TRUE,
             quote="\"",
             as.is=TRUE)
}
```

```{r}
eej_dataset_dir <- file.path(fd, "Dataset_of_EEJs")
all_files <- list.files(eej_dataset_dir, full.names = TRUE)
combined_df <- readTxt(all_files[[1]])

for (i in 2:length(all_files)) {
  combined_df <- full_join(combined_df, 
                           all_files[[i]], by = c("eej_id", "gene_id", "seqnames", "start", "end", "strand"))
}

str(combined_df)
```

```{r}
raw_eejs <- get_eej(combined_df, use_raw)
```

```{r}
ss_df <- readTxt(file.path(fd, "EEJ_filtered_DC.txt"))
mean(ss_df$sum_samples)
min(ss_df$sum_samples)
ncol(ss_df)
ss_df$sum_samples[1]
ss_df[1, !(colnames(ss_df) %in% 
                                    c("eej_id", "gene_id", "seqnames", 
                                    "start", "end", "width", "strand", 
                                    "intron_length", "sum_samples"))]

ss_df$sum_samples_2 <- rowSums(ss_df[, !(colnames(ss_df) %in% 
                                    c("eej_id", "gene_id", "seqnames", 
                                    "start", "end", "width", "strand", 
                                    "intron_length", "sum_samples"))])

mean(ss_df$sum_samples_2)
max(ss_df$sum_samples_2)
mean(ss_df$sum_samples_2 > 1)
plot(density(log10(ss_df$sum_samples_2)))

ss_df$sum_samples_ratio <- ss_df$sum_samples_2 / 443
write.table(ss_df, file=file.path(fd, "EEJ_filtered_DC_recalc.txt"), sep='\t')

ss_df_300samples <- ss_df[ss_df$sum_samples_2 > 300,]
write.table(ss_df_300samples, file=file.path(fd, "EEJ_filtered_DC_300.txt"), sep='\t')

ss_df_200samples <- ss_df[ss_df$sum_samples_2 > 200,]
write.table(ss_df_200samples, file=file.path(fd, "EEJ_filtered_DC_200.txt"), sep='\t')

plot(density(ss_df_300samples$sum_samples_2))
```

# Setecting sites within categories

```{r}
kasumi_dir <- file.path(fd, "Kasumi-1_cells")
kasumi_files <- c(list.files(kasumi_dir, full.names = TRUE),
               file.path(fd, "Dataset_of_EEJs", "Kasumi-1, control cells, EEJs from original RNA-Seq.txt"))
```

```{r}
kasumi_df <- readTxt(kasumi_files[[1]])

for (i in 2:length(kasumi_files)) {
  kasumi_df <- full_join(kasumi_df, 
                           readTxt(kasumi_files[[i]]), by = c("eej_id", "gene_id", "seqnames", "start", "end", "width", "strand"))
}

kasumi_df[is.na(kasumi_df)] <- 0
kasumi_df
```

```{r}
kasumi_cpm <- get_eej(kasumi_df)
write.table(kasumi_cpm, file = file.path(fd, "EEJ_Kasumi_filtered_CPM-1.txt"), sep = '\t')

kasumi_raw <- get_eej(kasumi_df, use_raw = TRUE)
write.table(kasumi_cpm, file = file.path(fd, "EEJ_Kasumi_filtered_raw10.txt"), sep = '\t')

common <- (kasumi_cpm$eej_id %in% kasumi_raw$eej_id)  
kasumi_dc <- kasumi_cpm[common,]
write.table(kasumi_dc, file = file.path(fd, "EEJ_Kasumi_filtered_DC.txt"), sep = '\t')
```

```{r}
ref_path = file.path(fd, "Homo_sapiens.GRCh38.dna_sm.toplevel.fa")
ref_idx_path = file.path(fd, "Homo_sapiens.GRCh38.dna_sm.toplevel.fa.fai")
file <- FaFile(ref_path, index=ref_idx_path)
fasta <- open(file)


kasumi_dc$seqnames <- gsub("chr", "", kasumi_dc$seqnames)
kasumi_dc_short <- cbind(kasumi_dc[,1:8], sum_samples = kasumi_dc$sum_samples)
kasumi_dc_ss_coords <- get_SS_from_EEJ(read_from_file=FALSE, df=kasumi_dc_short)

ss <- c(rep(5, length(kasumi_dc_ss_coords$fiveSSs)),
        rep(3, length(kasumi_dc_ss_coords$threeSSs)))

kasumi_dc_ss_coords_df <- rbind(as.data.frame(kasumi_dc_ss_coords$fiveSSs), 
                                as.data.frame(kasumi_dc_ss_coords$threeSSs))

kasumi_dc_ss_coords_df$ss <- ss
kasumi_dc_ss_coords_df$ss_start <- kasumi_dc_ss_coords_df$start
kasumi_dc_ss_coords_df$ss_end <- kasumi_dc_ss_coords_df$end

kasumi_dc_ss_coords_df <- add_refseqs(fasta, kasumi_dc_ss_coords_df, source="EEJ")
write.table(kasumi_dc_ss_coords_df, file = file.path(fd, "EEJ_Kasumi_filtered_DC_with_refseqs.txt"), sep = '\t')
```


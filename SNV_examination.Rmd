---
title: "SNV examination"
author: "Nadzeya Boyeva"
date: "2024-11-01"
output: html_document
---

```{r message=FALSE, include=FALSE}
library(ggplot2)
library(VariantAnnotation)
library(dplyr)
source("/home/nadzeya/Documents/GitHub/Splicing_SNV/SNV_examination_functions.R")
```

```{r}
fd <- '/home/nadzeya/praktika/'
gen_vcf1_path = file.path(fd, "gen1_snps_f.vcf.gz")
gen_vcf2_path = file.path(fd, "gen2_snps_f.vcf.gz")
gen_merged_vcf_path <- file.path(fd, "gen_merged_snps_f.vcf.gz")
nas_vcf1_path <- file.path(fd, "nas1_snps_f.vcf.gz")
nas_vcf2_path <- file.path(fd, "nas2_snps_f.vcf.gz")
nas_vcf3_path <- file.path(fd, "nas3_2_snps_f.vcf.gz")
nas_merged_vcf_path <- file.path(fd, "nas_merged_snps_f.vcf.gz")

filepaths <- c(gen_vcf1_path,
               gen_vcf2_path,
               gen_merged_vcf_path,
               nas_vcf1_path,
               nas_vcf2_path,
               nas_vcf3_path,
               nas_merged_vcf_path)

labels <- c('Gen 1', 
            'Gen 2',
            'Gen Merged',
            'Nas 1',
            'Nas 2',
            'Nas 3',
            'Nas Merged')
```

# Comparison of SNV quality metrics across files

```{r}
gen1 <- readVcf(gen_vcf1_path, "hg38")
descriptions <- info(header(gen1))
descriptions_df <- data.frame(Description = descriptions$Description,
                              row.names = rownames(descriptions))
descriptions_df
```

```{r}
full_info_table <- create_full_info_table(filepaths)
```

```{r}
plot_density(full_info_table, "AC", labels, descriptions)
```

```{r}
plot_density(full_info_table, "AF", labels, descriptions)
```

```{r}
plot_density(full_info_table, "MLEAC", labels, descriptions)
```

```{r}
plot_density(full_info_table, "MLEAF", labels, descriptions)
```

```{r}
plot_density(full_info_table, 'DP', labels, descriptions, x_log10=TRUE)
```

```{r}
plot_density(full_info_table, 'MQ', labels, descriptions, y_log10=TRUE)
```

```{r}
plot_density(full_info_table, 'QD', labels, descriptions)
```

```{r}
plot_density(full_info_table, 'SOR', labels, descriptions)
```

# Analysis of intersections

```{r message=FALSE, warning=FALSE, include=FALSE}
library(VennDiagram)
flog.threshold(ERROR)
source('venn_plot_functions.R')
```

```{r message=FALSE, warning=FALSE}
gen1_uf <- load_vcf(gen_vcf1_path, hardfilter=FALSE)
gen2_uf <- load_vcf(gen_vcf2_path, hardfilter=FALSE)
gen_merged_uf <- load_vcf(gen_merged_vcf_path, hardfilter=FALSE)
nas1_uf <- load_vcf(nas_vcf1_path, hardfilter=FALSE)
nas2_uf <- load_vcf(nas_vcf2_path, hardfilter=FALSE)
nas3_uf <- load_vcf(nas_vcf3_path, hardfilter=FALSE)
nas_merged_uf <- load_vcf(nas_merged_vcf_path, hardfilter=FALSE)

gen1 <- load_vcf(gen_vcf1_path)
gen2 <- load_vcf(gen_vcf2_path)
gen_merged <- load_vcf(gen_merged_vcf_path)
nas1 <- load_vcf(nas_vcf1_path)
nas2 <- load_vcf(nas_vcf2_path)
nas3 <- load_vcf(nas_vcf3_path)
nas_merged <- load_vcf(nas_merged_vcf_path)
```

## Genomic SNVs

```{r echo=TRUE}
plot_venn_4sets(data_list=list(gen1_uf, 
                          gen1,
                          gen2_uf,
                          gen2),
            param='All SNPs', 
            labels=c("Sample 1, unfiltered",
                     "Sample 1, filtered",
                     "Sample 2, unfiltered",
                     "Sample 2, filtered"), 
            title="Genomic SNV intersections")
```

```{r}
plot_venn_3sets(data_list=list(gen1,
                               gen2,
                               gen_merged),
          param='All SNPs', 
          labels=c("Sample 1",
                   "Sample 2",
                   "Merged samples"), 
          title="Genomic SNVs intersections")
```

## Nascent SNVs

```{r}
plot_venn_4sets(data_list=list(nas1, 
                               nas2, 
                               nas3, 
                               nas_merged),
          param='All SNPs', 
          labels=c("Sample 1",
                   "Sample 2",
                   "Sample 3",
                   "Merged samples"), 
          title="Nascent RNA SNVs")
```

## Genomic and nascent SNVs

```{r}
length(gen_merged@ranges@NAMES)
length(nas_merged@ranges@NAMES)
length(intersect(gen_merged@ranges@NAMES, nas_merged@ranges@NAMES))
```

```{r}
gen_common <- gen_merged[gen_merged@ranges@NAMES %in% 
                           Reduce(intersect, list(gen1@ranges@NAMES, 
                                                  gen2@ranges@NAMES, 
                                                  gen_merged@ranges@NAMES))]

nas_common <- nas_merged[nas_merged@ranges@NAMES %in% 
                           Reduce(intersect, list(nas1@ranges@NAMES, 
                                                  nas2@ranges@NAMES, 
                                                  nas3@ranges@NAMES, 
                                                  nas_merged@ranges@NAMES))]
```

```{r}
plot_venn_4sets(data_list=list(gen_merged, 
                               gen_common, 
                               nas_merged, 
                               nas_common),
          param='All SNPs', 
          labels=c("Genomic (merged samples)",
                   "Genomic (intersection)",
                   "Nascent (merged samples)",
                   "Nascent (intersection)"), 
          title="Genomic and nascent RNA SNVs")
```

```{r}
gen_common_uf <- gen_merged_uf[gen_merged_uf@ranges@NAMES %in% 
                           Reduce(intersect, list(gen1_uf@ranges@NAMES, 
                                                  gen2_uf@ranges@NAMES, 
                                                  gen_merged_uf@ranges@NAMES))]

nas_common_uf <- nas_merged_uf[nas_merged_uf@ranges@NAMES %in% 
                           Reduce(intersect, list(nas1_uf@ranges@NAMES, 
                                                  nas2_uf@ranges@NAMES, 
                                                  nas3_uf@ranges@NAMES, 
                                                  nas_merged_uf@ranges@NAMES))]

plot_venn_4sets(data_list=list(gen_merged_uf, 
                               gen_common_uf, 
                               nas_merged_uf, 
                               nas_common_uf),
          param='All SNPs', 
          labels=c("Genomic (merged samples)",
                   "Genomic (intersection)",
                   "Nascent (merged samples)",
                   "Nascent (intersection)"), 
          title="Genomic and nascent RNA SNVs (unfiltered)")
```

```{r}
common_snps <- Reduce(intersect, list(nas1@ranges@NAMES, 
                                      nas2@ranges@NAMES, 
                                      nas3@ranges@NAMES, 
                                      nas_merged@ranges@NAMES))
```

# Comparison of unique and intersecting SNVs

```{r}
# Extract INFO tables and SNV positions
info_tables <- lapply(filepaths, extract_info_and_positions)

# Identify unique and common SNV sets based on positions (constant)
snv_set_positions <- identify_snv_sets_positions(lapply(info_tables, function(x) x$positions), 
                                                 labels)
```

```{r}
param_name <- "AC" 
snv_set_with_metric <- extract_metric_from_info_tables(info_tables, param_name, snv_set_positions)
plot_ac <- plot_snv_density(snv_set_with_metric, param_name, descriptions_df)
print(plot_ac)
```

```{r}
param_name <- "QD"
snv_set_with_metric <- extract_metric_from_info_tables(info_tables, param_name, snv_set_positions)
plot_qd <- plot_snv_density(snv_set_with_metric, param_name, descriptions_df)
print(plot_qd)
```

```{r}
param_name <- "MQ"  # Example parameter
snv_set_with_metric <- extract_metric_from_info_tables(info_tables, param_name, snv_set_positions)
plot_mq <- plot_snv_density(snv_set_with_metric, param_name, descriptions, x_log10 = FALSE, y_log10 = TRUE)
print(plot_mq)
```

```{r}
param_name <- "SOR"
snv_set_with_metric <- extract_metric_from_info_tables(info_tables, param_name, snv_set_positions)
plot_sor <- plot_snv_density(snv_set_with_metric, param_name, descriptions_df, x_log10 = FALSE, y_log10 = FALSE)
print(plot_sor)
```

# 

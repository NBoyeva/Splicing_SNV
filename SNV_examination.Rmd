---
title: "SNV examination"
author: "Nadzeya Boyeva"
date: "2024-11-01"
output: html_document
---

```{r message=FALSE, include=FALSE}
library(ggplot2)
library(VariantAnnotation)
library(dplyr)
```

```{r}
fd <- '/home/nadzeya/praktika/'
gen_vcf1_path = file.path(fd, "gen1_snps_f.vcf.gz")
gen_vcf2_path = file.path(fd, "gen2_snps_f.vcf.gz")
gen_merged_vcf_path <- file.path(fd, "gen_merged_snps_f.vcf.gz")
nas_vcf1_path <- file.path(fd, "nas1_snps_f.vcf.gz")
nas_vcf2_path <- file.path(fd, "nas2_snps_f.vcf.gz")
nas_vcf3_path <- file.path(fd, "nas3_2_snps_f.vcf.gz")
nas_merged_vcf_path <- file.path(fd, "nas_merged_snps_f.vcf.gz")

filepaths <- c(gen_vcf1_path,
               gen_vcf2_path,
               gen_merged_vcf_path,
               nas_vcf1_path,
               nas_vcf2_path,
               nas_vcf3_path,
               nas_merged_vcf_path)

labels <- c('Gen 1', 
            'Gen 2',
            'Gen Merged',
            'Nas 1',
            'Nas 2',
            'Nas 3',
            'Nas Merged')
```

```{r}
gen1 <- load_vcf(gen_vcf1_path)
gen1_info <- info(readVcf(gen_vcf1_path, "hg38"))
gen1_info$AC
gen1_info$AF
gen1_info$AN
gen1_info$DP
gen1_info$MLEAC
gen1_info$MLEAF
gen1_info$MQ
gen1_info$QD
gen1_info$SOR
params <- c('AC', 'AF', 'AN', 'DP', 'MLEAC', 'MLEAF', 'MQ', 'QD', 'SOR')
```

# Comparison of SNV quality metrics across files

```{r}
descriptions <- info(header(gen1))
descriptions_df <- data.frame(Description = descriptions$Description,
                              row.names = rownames(descriptions))
descriptions_df
```

```{r}
create_full_info_table <- function(filepaths) {
  info_tables <- list()
  
  for (i in seq_along(filepaths)) {
    # Read the VCF file
    vcf <- readVcf(filepaths[i], "hg38")
    
    # Extract the INFO field
    info_table <- info(vcf)
    
    # Store the INFO table in the list
    info_tables[[i]] <- as.data.frame(info_table)
  }
  
  return(info_tables)
}



# Create the full_info_tables
full_info_table <- create_full_info_table(filepaths)
```

```{r}
plot_density <- function(info_tables, 
                         param_name, 
                         labels, 
                         descriptions, 
                         x_log10 = FALSE, 
                         y_log10 = FALSE) {

  data_list <- list()
  
  for (i in seq_along(info_tables)) {

    if (param_name %in% names(info_tables[[i]])) {
      parameter_data <- unlist(info_tables[[i]][[param_name]])  
      
      if (length(parameter_data) > 0) {
        data_list[[i]] <- data.frame(
          Value = parameter_data,
          File = labels[i]
        )
      }
    } else {
      warning(paste("Error: parameter", param_name, "not found in", labels[i]))
    }
  }
  
  if (length(data_list) == 0) {
    stop("Error: no valid data found for the specified parameter")
  }
  
  combined_data <- do.call(rbind, data_list)
  
  x_label <- if (x_log10) paste(param_name, "(log10 scale)") else param_name
  y_label <- if (y_log10) "Density (log10 scale)" else "Density"
  
  p <- ggplot(combined_data, aes(x = Value, color = File)) +
    geom_density() +
    labs(title = descriptions[param_name, ]$Description,
         x = x_label,
         y = y_label) +
    theme_minimal() +
    theme(legend.title = element_blank())
  
  if (x_log10) {
    p <- p + scale_x_log10()
  }
  if (y_log10) {
    p <- p + scale_y_log10()
  }
  
  return(p)
}

plot_density(full_info_table, "AC", labels, descriptions)
```

```{r}
plot_density(full_info_table, 'DP', labels, descriptions, x_log10=TRUE)
```

```{r}
plot_density(full_info_table, 'MQ', labels, descriptions, y_log10=TRUE)
```

```{r}
plot_density(full_info_table, 'QD', labels, descriptions)
```

```{r}
plot_density(full_info_table, 'SOR', labels, descriptions)
```

# Analysis of intersections

```{r message=FALSE, warning=FALSE}
library(VennDiagram)
flog.threshold(ERROR)
source('venn_plot_functions.R')

hardfilter_vcf <- function(unfiltered_vcf, stats=FALSE) {
  
  # This function applies VCF filtration and returns filtration statistics 
  # (optionally). Prior to this, VCF should be processed with FilterVariants
  # from GATK.
  
  if (stats) {
    print(paste0("Filtered by FS:  ", 
                 as.character(length(
                   unfiltered_vcf[unfiltered_vcf$FILTER == "FS"]))))
    print(paste0("Filtered by SOR: ", 
                 as.character(length(
                   unfiltered_vcf[unfiltered_vcf$FILTER == "SOR"]))))
    print(paste0("Filtered by QUAL:  ", 
                 as.character(length(
                   unfiltered_vcf[unfiltered_vcf$FILTER == "QUAL"]))))
    print(paste0("Filtered by MQ:  ", 
                 as.character(length(
                   unfiltered_vcf[unfiltered_vcf$FILTER == "MQ"]))))
    print(paste0("Filtered by ReadPosRankSum:  ", 
                 as.character(length(
                   unfiltered_vcf[unfiltered_vcf$FILTER == "ReadPosRankSum"]))))
    print(paste0("Filtered by MQRankSum: ", 
                 as.character(length(
                   unfiltered_vcf[unfiltered_vcf$FILTER == "MQRankSum"]))))
  }
  return(unfiltered_vcf[unfiltered_vcf$FILTER == "PASS"])
}

load_vcf <- function(path, hardfilter=TRUE, stats=FALSE) {
  vcf_file <- readVcf(path, "hg38")
  gr_vcf <- granges(vcf_file)
  if (hardfilter) {
    gr_vcf <- hardfilter_vcf(gr_vcf, stats=stats)
  }
  return(gr_vcf)
}
```

```{r message=FALSE, warning=FALSE}
gen1_uf <- load_vcf(gen_vcf1_path, hardfilter=FALSE)
gen2_uf <- load_vcf(gen_vcf2_path, hardfilter=FALSE)
gen_merged_uf <- load_vcf(gen_merged_vcf_path, hardfilter=FALSE)
nas1_uf <- load_vcf(nas_vcf1_path, hardfilter=FALSE)
nas2_uf <- load_vcf(nas_vcf2_path, hardfilter=FALSE)
nas3_uf <- load_vcf(nas_vcf3_path, hardfilter=FALSE)
nas_merged_uf <- load_vcf(nas_merged_vcf_path, hardfilter=FALSE)

gen1 <- load_vcf(gen_vcf1_path)
gen2 <- load_vcf(gen_vcf2_path)
gen_merged <- load_vcf(gen_merged_vcf_path)
nas1 <- load_vcf(nas_vcf1_path)
nas2 <- load_vcf(nas_vcf2_path)
nas3 <- load_vcf(nas_vcf3_path)
nas_merged <- load_vcf(nas_merged_vcf_path)
```

## Genomic SNVs

```{r}
plot_venn_4sets(data_list=list(gen1_uf, 
                          gen1,
                          gen2_uf,
                          gen2),
            param='All SNPs', 
            labels=c("Sample 1, unfiltered",
                     "Sample 1, filtered",
                     "Sample 2, unfiltered",
                     "Sample 2, filtered"), 
            title="Genomic SNV intersections")
```

```{r}
plot_venn_3sets(data_list=list(gen1,
                               gen2,
                               gen_merged),
          param='All SNPs', 
          labels=c("Sample 1",
                   "Sample 2",
                   "Merged samples"), 
          title="Genomic SNVs intersections")
```

## Nascent SNVs

```{r}
plot_venn_4sets(data_list=list(nas1, 
                               nas2, 
                               nas3, 
                               nas_merged),
          param='All SNPs', 
          labels=c("Sample 1",
                   "Sample 2",
                   "Sample 3",
                   "Merged samples"), 
          title="Nascent RNA SNVs")
```

## Genomic and nascent SNVs

```{r}
length(gen_merged@ranges@NAMES)
length(nas_merged@ranges@NAMES)
length(intersect(gen_merged@ranges@NAMES, nas_merged@ranges@NAMES))
```

# Comparison of unique and intersecting SNVs

```{r}
# Extract the INFO tables and SNV positions from VCF files
extract_info_and_positions <- function(filepath) {
  
  vcf <- readVcf(filepath, "hg38")
  info_table <- info(vcf)
  snv_positions <- rownames(vcf)
  
  return(list(info_table = info_table, 
              positions = snv_positions))
}
```

```{r}
# Identify unique and common SNVs based on positions
identify_snv_sets_positions <- function(snv_positions, 
                                        file_labels) {
  
  # Identify unique SNVs for each file based on positions
  unique_snvs <- lapply(seq_along(snv_positions), 
                        function(i) {
    all_other_snvs <- unlist(snv_positions[-i])
    unique_positions <- snv_positions[[i]][!(snv_positions[[i]] %in% all_other_snvs)]
    return(data.frame(Position = unique_positions, File = paste(file_labels[i], "unique")))
  })
  
  # Identify common SNVs in genomic VCFs 
  gen_files <- c("gen1", "gen2", "gen_merged")
  gen_indices <- which(file_labels %in% gen_files)
  gen_common_positions <- Reduce(intersect, lapply(gen_indices, function(i) snv_positions[[i]]))
  gen_common_snvs <- data.frame(Position = gen_common_positions, File = "gen common")
  
  # Identify common SNVs in nascent VCFs
  nas_files <- c("nas1", "nas2", "nas3", "nas_merged")
  nas_indices <- which(file_labels %in% nas_files)
  nas_common_positions <- Reduce(intersect, lapply(nas_indices, function(i) snv_positions[[i]]))
  nas_common_snvs <- data.frame(Position = nas_common_positions, File = "nas common")
  
  # Identify common SNVs across all files
  all_common_positions <- Reduce(intersect, snv_positions)
  all_common_snvs <- data.frame(Position = all_common_positions, File = "all common")
  
  # Combine all sets
  combined_positions <- bind_rows(unique_snvs, gen_common_snvs, nas_common_snvs, all_common_snvs)
  return(combined_positions)
}
```

```{r}
# Helper function to extract common metrics for "gen common", "nas common", and "all common"
extract_common_metric <- function(info_tables, param_name, snv_set) {
  positions <- snv_set$Position  # SNV positions from the common SNV set
  
  # Initialize an empty vector to store the parameter values for the common SNVs
  common_values <- rep(NA, length(positions))
  
  # Iterate over each INFO table in the group (e.g., gen1, gen2, gen_merged for gen common)
  for (i in seq_along(info_tables)) {
    
    if (param_name %in% names(info_tables[[i]]$info_table)) {
      # Extract all parameter values for this file
      param_values <- unlist(info_tables[[i]]$info_table[[param_name]])
      
      # Get the positions that match the common SNV positions
      matched_indices <- match(positions, info_tables[[i]]$positions)
      
      # Extract the parameter values corresponding to the matched positions
      common_values <- ifelse(!is.na(matched_indices), 
                              param_values[matched_indices], 
                              common_values)
    } else {
      next
    }
  }
  
  if (length(common_values) != length(positions)) {
    stop("Mismatch between common parameter values and positions in the common SNV set.")
  }

  return(common_values)
}
```

```{r}
# Function to extract parameter values for SNV sets using stored INFO tables
extract_metric_from_info_tables <- function(info_tables, 
                                            param_name, 
                                            snv_set) {
  
  # Initialize an empty list to store the parameter values for unique SNVs
  param_values_list <- list()

  # Iterate over each file's INFO table to extract the relevant parameter for unique SNVs
  for (i in seq_along(info_tables)) {
    
    # Get the SNV positions for this file in the SNV set
    positions_in_file <- snv_set$Position[snv_set$File == paste0(labels[i], " unique")]
    
    # Check if the parameter exists in the INFO table
    if (param_name %in% names(info_tables[[i]]$info_table)) {
      
      # Extract all the parameter values from the INFO table
      param_values <- unlist(info_tables[[i]]$info_table[[param_name]])
      
      # Filter the parameter values based on the SNV positions
      matched_indices <- match(positions_in_file, 
                               info_tables[[i]]$positions)
      matched_values <- param_values[matched_indices]
      
      # Ensure that the number of values matches the number of positions in the SNV set
      if (length(matched_values) != length(positions_in_file)) {
        stop("Mismatch between the number of matched 
             parameter values and positions in the SNV set.")
      }
      
      # Add the matched values to the list
      param_values_list[[i]] <- matched_values
      
    } else {
      
      # If the parameter doesn't exist, return NA values for the positions
      param_values_list[[i]] <- rep(NA, length(positions_in_file))
      
    }
  }
  
  unique_values <- unlist(param_values_list)
  
  # Update the SNV set with the extracted metric values for unique SNVs
  snv_set$Value[snv_set$File %in% paste0(labels, " unique")] <- unique_values
  
  # Extract and update metrics for the common SNV sets 
  # (e.g., "gen common", "nas common", "all common")
  common_files <- c("gen common", "nas common", "all common")
  for (common_file in common_files) {
    common_indices <- which(snv_set$File == common_file)
    
    # For common SNVs, use the first file in the group to extract values
    if (common_file == "gen common") {
      snv_set$Value[common_indices] <- extract_common_metric(info_tables[1:3], 
                                                             param_name, 
                                                             snv_set[common_indices, ])
    } else if (common_file == "nas common") {
      snv_set$Value[common_indices] <- extract_common_metric(info_tables[4:7], 
                                                             param_name, 
                                                             snv_set[common_indices, ])
    } else if (common_file == "all common") {
      snv_set$Value[common_indices] <- extract_common_metric(info_tables, 
                                                             param_name, 
                                                             snv_set[common_indices, ])
    }
  }
  
  return(snv_set)
}
```

```{r}
# Function to plot the SNV data with different parameter metrics
plot_snv_density <- function(snv_set_with_metric, 
                             param_name, 
                             descriptions, 
                             x_log10 = FALSE, 
                             y_log10 = FALSE) {
  
  # Adjust axis labels based on log10 options
  x_label <- if (x_log10) paste(param_name, "(log10 scale)") else param_name
  y_label <- if (y_log10) "Density (log10 scale)" else "Density"
  
  # Create a column to adjust line thickness for common SNVs
  snv_set_with_metric$LineThickness <- ifelse(snv_set_with_metric$File %in% 
                                                c("gen common", 
                                                  "nas common", 
                                                  "all common"), 1.5, 0.5)
  
  # Create the density plot
  p <- ggplot(snv_set_with_metric, aes(x = Value, 
                                       color = File, 
                                       size = LineThickness)) +
    geom_density() +
    labs(title = descriptions[[param_name, "Description"]],
         x = x_label,
         y = y_label) +
    theme_minimal() +
    scale_size_identity() +
    theme(legend.title = element_blank())
  
  # Apply log10 scale to x or y axis if requested
  if (x_log10) {
    p <- p + scale_x_log10()
  }
  if (y_log10) {
    p <- p + scale_y_log10()
  }
  
  return(p)
}
```

```{r}
# Extract INFO tables and SNV positions
info_tables <- lapply(filepaths, extract_info_and_positions)

# Identify unique and common SNV sets based on positions (constant)
snv_set_positions <- identify_snv_sets_positions(lapply(info_tables, function(x) x$positions), 
                                                 labels)
```

```{r}
param_name <- "AC" 
snv_set_with_metric <- extract_metric_from_info_tables(info_tables, param_name, snv_set_positions)
plot_ac <- plot_snv_density(snv_set_with_metric, param_name, descriptions_df)
print(plot_ac)
```

```{r}
param_name <- "QD"
snv_set_with_metric <- extract_metric_from_info_tables(info_tables, param_name, snv_set_positions)
plot_qd <- plot_snv_density(snv_set_with_metric, param_name, descriptions_df)
print(plot_qd)
```

```{r}
param_name <- "MQ"  # Example parameter
snv_set_with_metric <- extract_metric_from_info_tables(info_tables, param_name, snv_set_positions)
plot_mq <- plot_snv_density(snv_set_with_metric, param_name, descriptions, x_log10 = FALSE, y_log10 = TRUE)
print(plot_mq)
```

```{r}
param_name <- "SOR"
snv_set_with_metric <- extract_metric_from_info_tables(info_tables, param_name, snv_set_positions)
plot_sor <- plot_snv_density(snv_set_with_metric, param_name, descriptions_df, x_log10 = FALSE, y_log10 = FALSE)
print(plot_sor)
```

# 
